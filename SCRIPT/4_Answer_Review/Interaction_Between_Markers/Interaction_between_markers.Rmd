---
title: "Interaction between markers"
author: "Yan Holtz"
date: "October 2016"
output:
  rmdformats::readthedown:
    highlight: kate
  html_document:
    toc: yes
---

```{r setup, include=FALSE}
# To use cache in the document
knitr::opts_chunk$set(cache=TRUE)
```

This file aims to provide more details concerning the epistatic relationships between every pairs of markers. The idea is to calculate the interaction term of every pair of markers. To avoid huge computation time, we considered only one marker every slice of 10 cM along the genetic map.

# Calculate interactions


The study is done using the QTLRel library
```{r}
library(QTLRel)
library(xtable)
```












# Symptom Severity (SS)

## Load data
I load the genotyping matrix first.
```{r}
genotype<-read.table("/Users/holtz/Dropbox/Publi_Mosaique/DATA/DATA/GROUPED/genotypage.csv", sep = ";" , header = F, na.strings = "-")
genotype=as.matrix(genotype)
colnames(genotype)=genotype[1,]
genotype=as.data.frame(genotype[-1 , ])
names(genotype)[1]<-"geno"
print("--- Your genotyping matrix looks correct. Dimension of the matrix are :")
print(dim(genotype))
# I copy this matrix 2 times, since I read 2012 and 2015 together.
rownames(genotype)=genotype[,1]
genotype=genotype[,-1]
a=genotype ; rownames(a)=paste(rownames(a),"2012",sep="_")
b=genotype ; rownames(b)=paste(rownames(b),"2015",sep="_")
genotype=rbind(a,b)
```

Then the genetic map:
```{r}
map <- read.table("/Users/holtz/Dropbox/Publi_Mosaique/DATA/DATA/genetic_map.txt" , header=T , dec = ".", na.strings = "-" , check.names=F)
colnames(map) <- c("LG", "marqueur", "Distance","group_physique","Posi_physique")
rownames(map) <- map$marqueur
map$LG <- as.factor(map$LG)
print("--- Your genetic map looks correct. Dimension of the map are :")
print(dim(map))
map=map[	, c(2,1,3,5)]
colnames(map)=c("snp","chr", "dist", "phyPos")
```

And finally the phenotyping matrix
```{r}
BLUP<-read.table("/Users/holtz/Dropbox/Publi_Mosaique/DATA/DATA/GROUPED/phenotypage.csv", header = TRUE, sep=";")
colnames(BLUP)[1]="geno"
print("--- Your Phenotyping matrix looks correct. Dimension of the matrix are :")
print(dim(BLUP))
# Fichier de phénotypage modifié, il va falloir mettre la NV de 2012 et 2015 ensemble, avec une colonne année.
a=BLUP[, c(1,2)] ; a$year="2012" ; colnames(a)=c("geno", "NV_blup_AR1","year") ; #a[,2]=a[,2]/0.745  # 
a[,2]=ifelse(substr(a$geno, 1,2)=="TT", a[,2]/0.66 , a[,2]/0.83)
b=BLUP[, c(1,4)] ; b$year="2015" ; colnames(b)=c("geno", "NV_blup_AR1", "year") ; #b[,2]=b[,2]/1.2   # 
b[,2]=ifelse(substr(b$geno, 1,2)=="TT", b[,2]/1.2 , a[,2]/1.21)
BLUP=rbind(a,b)
rownames(BLUP)=paste( BLUP[,1], BLUP$year,sep="_")
BLUP=BLUP[,-1]
# Note: On peut garder les blups tels quels / ou les pondéré par la variance génet de chaque année moyennée sur les 2 pops / ou par la variance génet de chaque année et chaque pop.
```


## Prepare data
We need to have genotype and phenotype in the same order:
```{r}
Y=na.omit(BLUP)
Y=Y[which(rownames(Y)%in%rownames(genotype)) , ]
genotype=genotype[which(rownames(genotype)%in%rownames(Y)) , ]
genotype=genotype[ match(rownames(Y),rownames(genotype)) , ]
```

## Calculate kinship matrix
```{r}
# missing data
set.seed(123)
XNNA=genotype
my_fun=function(x){length(x[x=="A" & !is.na(x) ])/length(!is.na(x)) }
prop=apply(XNNA , 2 , my_fun)
for(i in c(1:ncol(XNNA))){
 	aa=XNNA[,i][is.na(XNNA[,i])]
 	bb=rbinom(length(aa),1,prob=prop[i])
	XNNA[,i][is.na(XNNA[,i])]=c("B","A")[bb+1]
 	}
	
# Change "A" to "AA"
XNNA=as.matrix(XNNA)
XNNA[which(XNNA=="A")]<-"AA"
XNNA[which(XNNA=="B")]<-"BB"
	
# Kinship matrix
K<-genMatrix(XNNA)
	
# I = identity matrix
I<-diag(nrow(Y))
```



## Markers effect
We compute a complete modele in QTLRel including year effect, marker effect and interaction between both.This model is computed marker per marker using the scanOne function. We compare the likelihood of this model with the model that does not include any marker, what gives us the marker effect trough its LOD score.
```{r}
mod1<-estVC(y=Y$NV_blup_AR1, x=Y$year, v=list(AA=K$AA,DD=NULL,HH=NULL,AD=NULL,MH=NULL,EE=I))
llk.hk2 <- scanOne(y=Y$NV_blup_AR1, vc=mod1, intcovar=Y$year, gdat=XNNA ,test="Chisq")
```
Manhattan plot to visualize the effect of each marker.
```{r}
# Merge LODs with the genetic map
AA=merge(map,data.frame( names(llk.hk2$p) , llk.hk2$p), by.x=1 , by.y=1, all.x=T)
AA=AA[order(AA$chr, AA$dist) , ]
AA=AA[!is.na(AA$llk.hk2.p) , ]
# And plot it
plot(-log10(AA$llk.hk2.p) , pch=20 , col=as.numeric(AA$chr) , cex=1.3, xaxt="n" )
abline(h=3.6, col="grey", lwd=1.5)
num=seq(1,nrow(AA))
num=aggregate(num, by=list(AA$chr), mean , na.rm=T)
axis(1, at=num[,2], labels=num[,1])
```

Summary of the significant markers:
```{r}
to_print=AA[-log10(AA$llk.hk2.p)>3.61 , ] 
```

```{r aavfdjng, results='asis' , echo=FALSE}
print(xtable(to_print), type = "html", include.rownames = F , comment=FALSE)
```

## Interaction effect.
We can also check for which marker the **interaction** effect was significant?
```{r}
#Compute 2 models: one with interaction, one without interaction
llk.hk_inter1 <-scanOne(y=Y$NV_blup_AR1, x=Y$year, vc=mod1, gdat=XNNA ,test="None")
llk.hk_inter2 <- scanOne(y=Y$NV_blup_AR1, vc=mod1, intcovar=Y$year, gdat=XNNA ,test="None")

# Find pvalue of each marker for interaction significance
diff_deviance <- llk.hk_inter2$p - llk.hk_inter1$p
pvaluesexpected=1-pchisq(diff_deviance, 1)

# Merge with map
AA=merge(map,data.frame( names(pvaluesexpected) , pvaluesexpected), by.x=1 , by.y=1, all.x=T)
AA=AA[order(AA$chr, AA$dist) , ]
AA=AA[!is.na(AA$pvaluesexpected) , ]

# Plot
plot(-log10(AA$pvaluesexpected) , pch=20 , col=as.numeric(AA$chr) , cex=1.3, xaxt="n" )
abline(h=3.6, col="grey", lwd=1.5)
num=seq(1,nrow(AA))
num=aggregate(num, by=list(AA$chr), mean , na.rm=T)
axis(1, at=num[,2], labels=num[,1])
```






















# Elisa

## Load data
I load the genotyping matrix first.
```{r}
genotype<-read.table("/Users/holtz/Dropbox/Publi_Mosaique/DATA/DATA/GROUPED/genotypage.csv", sep = ";" , header = F, na.strings = "-")
genotype=as.matrix(genotype)
colnames(genotype)=genotype[1,]
genotype=as.data.frame(genotype[-1 , ])
names(genotype)[1]<-"geno"
print("--- Your genotyping matrix looks correct. Dimension of the matrix are :")
print(dim(genotype))
# I copy this matrix 2 times, since I read 2012 and 2015 together.
rownames(genotype)=genotype[,1]
genotype=genotype[,-1]
a=genotype ; rownames(a)=paste(rownames(a),"2012",sep="_")
b=genotype ; rownames(b)=paste(rownames(b),"2015",sep="_")
genotype=rbind(a,b)
```

Then the genetic map:
```{r}
map <- read.table("/Users/holtz/Dropbox/Publi_Mosaique/DATA/DATA/genetic_map.txt" , header=T , dec = ".", na.strings = "-" , check.names=F)
colnames(map) <- c("LG", "marqueur", "Distance","group_physique","Posi_physique")
rownames(map) <- map$marqueur
map$LG <- as.factor(map$LG)
print("--- Your genetic map looks correct. Dimension of the map are :")
print(dim(map))
map=map[	, c(2,1,3,5)]
colnames(map)=c("snp","chr", "dist", "phyPos")
```

And finally the phenotyping matrix
```{r}
BLUP<-read.table("/Users/holtz/Dropbox/Publi_Mosaique/DATA/DATA/GROUPED/phenotypage.csv", header = TRUE, sep=";")
colnames(BLUP)[1]="geno"
print("--- Your Phenotyping matrix looks correct. Dimension of the matrix are :")
print(dim(BLUP))
# Put ELisa2012 and 2015 together
a=BLUP[, c(1,3)] ; a$year="2012" ; colnames(a)=c("geno", "Elisa_blup_AR1","year") ; #a[,2]=a[,2]/0.745  # 
a[,2]=ifelse(substr(a$geno, 1,2)=="TT", a[,2]/0.08373045 , a[,2]/ 0.07145543)
b=BLUP[, c(1,5)] ; b$year="2015" ; colnames(b)=c("geno", "Elisa_blup_AR1", "year") ; #b[,2]=b[,2]/1.2   # 
b[,2]=ifelse(substr(b$geno, 1,2)=="TT", b[,2]/0.14488006 , a[,2]/0.13135315)
BLUP=rbind(a,b)
rownames(BLUP)=paste( BLUP[,1], BLUP$year,sep="_")
BLUP=BLUP[,-1]
# Note: On peut garder les blups tels quels / ou les pondéré par la variance génet de chaque année moyennée sur les 2 pops / ou par la variance génet de chaque année et chaque pop.
```


## Prepare data
We need to have genotype and phenotype in the same order:
```{r}
Y=na.omit(BLUP)
Y=Y[which(rownames(Y)%in%rownames(genotype)) , ]
genotype=genotype[which(rownames(genotype)%in%rownames(Y)) , ]
genotype=genotype[ match(rownames(Y),rownames(genotype)) , ]
```

## Calculate kinship matrix
```{r}
# missing data
set.seed(123)
XNNA=genotype
my_fun=function(x){length(x[x=="A" & !is.na(x) ])/length(!is.na(x)) }
prop=apply(XNNA , 2 , my_fun)
for(i in c(1:ncol(XNNA))){
 	aa=XNNA[,i][is.na(XNNA[,i])]
 	bb=rbinom(length(aa),1,prob=prop[i])
	XNNA[,i][is.na(XNNA[,i])]=c("B","A")[bb+1]
 	}
	
# Change "A" to "AA"
XNNA=as.matrix(XNNA)
XNNA[which(XNNA=="A")]<-"AA"
XNNA[which(XNNA=="B")]<-"BB"
	
# Kinship matrix
K<-genMatrix(XNNA)
	
# I = identity matrix
I<-diag(nrow(Y))
```



## Markers effect
We compute a complete modele in QTLRel including year effect, marker effect and interaction between both.This model is computed marker per marker using the scanOne function. We compare the likelihood of this model with the model that does not include any marker, what gives us the marker effect trough its LOD score.
```{r}
mod1<-estVC(y=Y$Elisa_blup_AR1, x=Y$year, v=list(AA=K$AA,DD=NULL,HH=NULL,AD=NULL,MH=NULL,EE=I))
llk.hk2 <- scanOne(y=Y$Elisa_blup_AR1, vc=mod1, intcovar=Y$year, gdat=XNNA ,test="Chisq")
```
Manhattan plot to visualize the effect of each marker.
```{r}
# Merge LODs with the genetic map
AA=merge(map,data.frame( names(llk.hk2$p) , llk.hk2$p), by.x=1 , by.y=1, all.x=T)
AA=AA[order(AA$chr, AA$dist) , ]
AA=AA[!is.na(AA$llk.hk2.p) , ]
# And plot it
plot(-log10(AA$llk.hk2.p) , pch=20 , col=as.numeric(AA$chr) , cex=1.3, xaxt="n" )
abline(h=3.6, col="grey", lwd=1.5)
num=seq(1,nrow(AA))
num=aggregate(num, by=list(AA$chr), mean , na.rm=T)
axis(1, at=num[,2], labels=num[,1])
```

Summary of the significant markers:
```{r}
to_print=AA[-log10(AA$llk.hk2.p)>3.61 , ] 
```

```{r addng, results='asis' , echo=FALSE}
print(xtable(to_print), type = "html", include.rownames = F , comment=FALSE)
```

## Interaction effect.
We can also check for which marker the **interaction** effect was significant?
```{r}
#Compute 2 models: one with interaction, one without interaction
llk.hk_inter1 <-scanOne(y=Y$Elisa_blup_AR1, x=Y$year, vc=mod1, gdat=XNNA ,test="None")
llk.hk_inter2 <- scanOne(y=Y$Elisa_blup_AR1, vc=mod1, intcovar=Y$year, gdat=XNNA ,test="None")

# Find pvalue of each marker for interaction significance
diff_deviance <- llk.hk_inter2$p - llk.hk_inter1$p
pvaluesexpected=1-pchisq(diff_deviance, 1)

# Merge with map
AA=merge(map,data.frame( names(pvaluesexpected) , pvaluesexpected), by.x=1 , by.y=1, all.x=T)
AA=AA[order(AA$chr, AA$dist) , ]
AA=AA[!is.na(AA$pvaluesexpected) , ]

# Plot
plot(-log10(AA$pvaluesexpected) , pch=20 , col=as.numeric(AA$chr) , cex=1.3, xaxt="n" )
abline(h=3.6, col="grey", lwd=1.5)
num=seq(1,nrow(AA))
num=aggregate(num, by=list(AA$chr), mean , na.rm=T)
axis(1, at=num[,2], labels=num[,1])
```

